<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Sainfoxiya Ltd</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Sora', sans-serif; background-color: #f0f2f5; color: #1a202c; }
        .aurora-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
        .aurora-bg::before, .aurora-bg::after {
            content: ''; position: absolute; width: 100vw; height: 100vh;
            background-image:
                radial-gradient(circle at 20% 20%, #89f7fe 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, #66a6ff 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, #ffdde1 0%, transparent 30%);
            mix-blend-mode: screen; filter: blur(80px); animation: moveAurora 20s infinite linear alternate;
        }
        .aurora-bg::after { animation-delay: -10s; }
        @keyframes moveAurora {
            from { transform: translate(-50%, -50%) rotate(0deg) scale(1.5); }
            to { transform: translate(0%, 0%) rotate(180deg) scale(1.5); }
        }
        .glass-nav, .glass-card, .glass-dropdown, .glass-modal {
            background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .input-field {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="antialiased">

    <div class="aurora-bg"></div>

    <!-- Header -->
    <header class="glass-nav sticky top-4 mx-auto max-w-7xl rounded-xl z-50 my-4">
        <nav class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-gray-800 tracking-tight">Sainfoxiya</a>
            <div id="user-menu" class="flex items-center space-x-4 relative">
                 <a href="#" title="Your Cart" class="text-gray-700 hover:text-gray-900 text-xl"><i class="fas fa-shopping-cart"></i></a>
                <button id="profile-menu-button" class="flex items-center space-x-2">
                    <img id="nav-profile-pic" src="https://placehold.co/32x32/E2E8F0/333?text=U" alt="User" class="w-8 h-8 rounded-full object-cover">
                    <span id="user-email-display" class="hidden md:block text-sm text-gray-600 font-medium"></span>
                </button>
                <div id="profile-dropdown" class="glass-dropdown absolute top-12 right-0 w-48 rounded-lg shadow-lg p-2 hidden">
                    <a href="#" id="manage-profile-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-white/50 rounded-md">Manage Profile</a>
                    <a href="#" id="order-history-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-white/50 rounded-md">Order History</a>
                    <div class="border-t border-gray-300/50 my-1"></div>
                    <a href="#" id="logout-button" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-white/50 rounded-md">Logout</a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="relative z-10 container mx-auto px-6 py-12">
        <div id="view-container">
            <!-- Dashboard View -->
            <div id="dashboard-view">
                <!-- ... Dashboard content ... -->
            </div>

            <!-- Manage Profile View -->
            <div id="profile-view" class="hidden">
                 <button class="back-to-dashboard-btn glass-card mb-8 px-4 py-2 rounded-lg font-semibold hover:bg-white">&larr; Back to Dashboard</button>
                 <h1 class="text-4xl font-bold text-gray-800 mb-8">Manage Profile</h1>
                 <div id="profile-message" class="hidden p-3 rounded-lg mb-4 text-sm text-center"></div>
                 <form id="profile-form">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 glass-card p-8 rounded-2xl">
                            <div class="flex justify-end mb-4">
                                <button type="button" id="edit-profile-btn" class="text-sm font-semibold text-blue-600 hover:underline">Edit Profile</button>
                            </div>
                            <div class="flex flex-col md:flex-row items-center md:space-x-8">
                                <div class="relative mb-6 md:mb-0">
                                    <label for="photo-upload" class="cursor-pointer">
                                        <img id="profile-picture" src="https://placehold.co/150x150/E2E8F0/333?text=User" alt="User Profile" class="w-36 h-36 rounded-full shadow-lg object-cover">
                                        <div class="absolute bottom-0 right-0 bg-gray-800 text-white w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-700">
                                            <i class="fas fa-camera"></i>
                                        </div>
                                    </label>
                                    <input type="file" id="photo-upload" class="hidden" accept="image/jpeg, image/png">
                                </div>
                                <div class="flex-grow w-full">
                                    <div class="space-y-4">
                                        <!-- Name -->
                                        <div>
                                            <label class="text-gray-600 text-sm">Name:</label>
                                            <input type="text" id="profile-name" class="w-full p-2 rounded-lg mt-1 input-field" disabled>
                                        </div>
                                        <!-- DOB -->
                                        <div>
                                            <label class="text-gray-600 text-sm">Date of Birth:</label>
                                            <input type="date" id="profile-dob" class="w-full p-2 rounded-lg mt-1 input-field" disabled>
                                        </div>
                                        <!-- Phone -->
                                        <div>
                                            <label class="text-gray-600 text-sm">Phone Number:</label>
                                            <input type="tel" id="profile-phone" class="w-full p-2 rounded-lg mt-1 input-field" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-8 text-right">
                                <button type="submit" id="save-profile-btn" class="hidden bg-gray-900 text-white font-semibold py-2 px-6 rounded-lg hover:bg-gray-800">Save Changes</button>
                            </div>
                        </div>
                        <!-- KYC Status Column -->
                        <div class="glass-card p-8 rounded-2xl">
                            <!-- ... KYC content ... -->
                        </div>
                     </div>
                 </form>
            </div>
            <!-- Order History View -->
            <div id="order-history-view" class="hidden">
                <!-- ... Order history content ... -->
            </div>
        </div>
    </main>

    <script type="module">
        // Firebase SDK se zaroori functions import karein
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWk4i6QDGIwh9jkNRM2X1n0AVlaeTDOeY",
            authDomain: "radha-fa803.firebaseapp.com",
            projectId: "radha-fa803",
            storageBucket: "radha-fa803.appspot.com",
            messagingSenderId: "837958379134",
            appId: "1:837958379134:web:001cc5699b958165bd9a2f",
            measurementId: "G-4FRHTBJSGJ"
        };

        // Firebase services ko initialize karein
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- DOM Elements ---
        const navProfilePic = document.getElementById('nav-profile-pic');
        const profilePicture = document.getElementById('profile-picture');
        const photoUpload = document.getElementById('photo-upload');
        const profileForm = document.getElementById('profile-form');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const saveProfileBtn = document.getElementById('save-profile-btn');
        const profileMessage = document.getElementById('profile-message');
        const profileNameInput = document.getElementById('profile-name');
        const profileDobInput = document.getElementById('profile-dob');
        const profilePhoneInput = document.getElementById('profile-phone');
        // (Other elements from previous steps)
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutButton = document.getElementById('logout-button');
        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileDropdown = document.getElementById('profile-dropdown');
        const manageProfileLink = document.getElementById('manage-profile-link');
        const orderHistoryLink = document.getElementById('order-history-link');
        const dashboardView = document.getElementById('dashboard-view');
        const profileView = document.getElementById('profile-view');
        const orderHistoryView = document.getElementById('order-history-view');
        const backToDashboardButtons = document.querySelectorAll('.back-to-dashboard-btn');

        let currentUser = null;

        // --- Auth State Management ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadUserProfile(user);
            } else {
                currentUser = null;
                window.location.href = 'login.html';
            }
        });
        
        // --- Profile Data Loading ---
        async function loadUserProfile(user) {
            userEmailDisplay.textContent = user.email;
            navProfilePic.src = user.photoURL || 'https://placehold.co/32x32/E2E8F0/333?text=U';
            profilePicture.src = user.photoURL || 'https://placehold.co/150x150/E2E8F0/333?text=User';

            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                profileNameInput.value = data.name || user.displayName || '';
                profileDobInput.value = data.dob || '';
                profilePhoneInput.value = data.phone || '';
            } else {
                profileNameInput.value = user.displayName || '';
            }
        }
        
        // --- Edit/Save Profile Logic ---
        editProfileBtn.addEventListener('click', () => {
            profileNameInput.disabled = false;
            profileDobInput.disabled = false;
            profilePhoneInput.disabled = false;
            saveProfileBtn.classList.remove('hidden');
            editProfileBtn.classList.add('hidden');
        });

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            
            const newName = profileNameInput.value;
            const newDob = profileDobInput.value;
            const newPhone = profilePhoneInput.value;

            saveProfileBtn.disabled = true;
            saveProfileBtn.textContent = 'Saving...';

            try {
                // Update Firestore
                const userDocRef = doc(db, "users", currentUser.uid);
                await setDoc(userDocRef, {
                    name: newName,
                    dob: newDob,
                    phone: newPhone
                }, { merge: true });

                // Update Auth profile
                await updateProfile(currentUser, { displayName: newName });
                
                showMessage('success', 'Profile updated successfully!');
                
                // Reset UI
                profileNameInput.disabled = true;
                profileDobInput.disabled = true;
                profilePhoneInput.disabled = true;
                saveProfileBtn.classList.add('hidden');
                editProfileBtn.classList.remove('hidden');

            } catch (error) {
                console.error("Error updating profile: ", error);
                showMessage('error', 'Failed to update profile.');
            } finally {
                saveProfileBtn.disabled = false;
                saveProfileBtn.textContent = 'Save Changes';
            }
        });

        // --- Profile Picture Upload ---
        photoUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file || !currentUser) return;

            // File type validation
            const allowedTypes = ['image/jpeg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                showMessage('error', 'Only JPG and PNG files are allowed.');
                return;
            }
            
            showMessage('info', 'Uploading photo...');

            const storageRef = ref(storage, `profile-pictures/${currentUser.uid}`);
            
            try {
                // Upload file
                const snapshot = await uploadBytes(storageRef, file);
                // Get download URL
                const downloadURL = await getDownloadURL(snapshot.ref);

                // Update profile picture on page
                profilePicture.src = downloadURL;
                navProfilePic.src = downloadURL;

                // Update Auth and Firestore
                await updateProfile(currentUser, { photoURL: downloadURL });
                const userDocRef = doc(db, "users", currentUser.uid);
                await setDoc(userDocRef, { photoURL: downloadURL }, { merge: true });
                
                showMessage('success', 'Profile photo updated!');

            } catch (error) {
                console.error("Error uploading photo: ", error);
                showMessage('error', 'Failed to upload photo.');
            }
        });

        function showMessage(type, text) {
            profileMessage.textContent = text;
            const colors = {
                success: 'bg-green-100 text-green-800',
                error: 'bg-red-100 text-red-800',
                info: 'bg-blue-100 text-blue-800'
            };
            profileMessage.className = `p-3 rounded-lg mb-4 text-sm text-center ${colors[type]}`;
            profileMessage.classList.remove('hidden');
            setTimeout(() => profileMessage.classList.add('hidden'), 4000);
        }

        // --- View Switching and Logout (from previous steps) ---
        logoutButton.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth);
        });
        
        function showView(viewToShow) {
            dashboardView.style.display = 'none';
            profileView.style.display = 'none';
            orderHistoryView.style.display = 'none';
            viewToShow.style.display = 'block';
        }

        manageProfileLink.addEventListener('click', (e) => { e.preventDefault(); showView(profileView); profileDropdown.classList.add('hidden'); });
        orderHistoryLink.addEventListener('click', (e) => { e.preventDefault(); showView(orderHistoryView); profileDropdown.classList.add('hidden'); });
        backToDashboardButtons.forEach(btn => btn.addEventListener('click', () => showView(dashboardView)));
        profileMenuButton.addEventListener('click', (e) => { e.stopPropagation(); profileDropdown.classList.toggle('hidden'); });
        window.addEventListener('click', (e) => { if (!profileMenuButton.contains(e.target)) profileDropdown.classList.add('hidden'); });

    </script>
</body>
</html>
